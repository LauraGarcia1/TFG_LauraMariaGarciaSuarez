{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block overflow %}

<body style="overflow-x: hidden;">
    {% endblock overflow %}

    {% block body %}
    <div class="position-relative custom-container">
        <div class="position-absolute top-0 start-0">
            <img src="{% static 'images/dicesLeft.png' %}" alt="Image" draggable="false"
                style="transform: rotate(64deg);">
        </div>

        <div class="position-absolute bottom-0 end-0">
            <img src="{% static 'images/dicesRight.png' %}" alt="Image" draggable="false"
                style="transform: rotate(31deg);">
        </div>

        <div
            class="justify-content-start shadow-lg p-5 bg-body rounded rounded-5 position-absolute top-0 start-50 translate-middle-x border border-dark border-2 custom-width">
            <div class="row h-100 p-5 rounded rounded-5 border border-dark border-1 w-100 background-creme">
                <!-- Form de Questionnarie -->
                {% csrf_token %}
                <h1>{% trans "CreateStudyTitle" %}</h1>
                <form id="questionnaire-form">
                    {{ questionnarie_form.as_p }}
                </form>
                <button id="create-section-btn" class="btn btn-primary rounded-pill btn-purple" disabled>{% trans "CreateSection" %}</button>
                <button id="delete-sections-btn" class="btn btn-danger rounded-pill" disabled>{% trans "DelSections" %}</button>

                <h3 class="pt-3">{% trans "Sections" %}</h3>
                {{ section_formset.management_form }}
                <div id="sections-container">
                    <!-- Secciones que se añaden dinámicamente -->
                    <script type="text/template" id="section-template">
                        <div class="row p-3 rounded rounded-5 border border-dark border-1 w-100 bg-body mb-3">
                            <div class="section-form" data-index="__index__">
                              <h3>{% trans "Section" %}</h3>
                                {% for form in section_formset %}
                                <div>
                                    {{ form.as_p }}
                                </div>
                                <button class="add-question-btn btn btn-primary rounded-pill btn-purple" disabled>{% trans "CreateQuestion" %}</button>
                                <button class="del-questions-btn btn btn-danger rounded-pill" disabled>{% trans "DelQuestions" %}</button>
                                {{ question_formset.management_form }}
                                  <!-- Contenedor para las preguntas de esta sección -->
                                    <div class="questions-container">
                                        <!-- Se agregarán los formularios de preguntas aquí -->
                                        <script type="text/template" id="question-template">
                                        <div class="row p-2 rounded rounded-5 border border-dark border-1 w-100 background-creme mt-3">
                                            <div class="question-form" data-index="__index__">
                                                <h4>{% trans "Question" %}</h4>
                                                {% for form_q in question_formset %}
                                                <div>
                                                    {{ form_q.as_p }}
                                                </div>
                                                <button class="add-choice-btn btn btn-primary rounded-pill btn-purple" disabled>{% trans "CreateChoice" %}</button>
                                                <button class="del-choices-btn btn btn-danger rounded-pill" disabled>{% trans "DelChoices" %}</button>
                                                {{ choice_formset.management_form }}
                                                <div class="row p-2 rounded rounded-5 border border-dark border-1 w-100 bg-body mt-3">
                                                    <h4>{% trans "Choices" %}</h4>
                                                    <div class="choices-container">
                                                    <!-- Se agregarán los formularios de preguntas aquí -->
                                                        <script type="text/template" id="choice-template">
                                                            <div class="choice-form">
                                                                {% for form_c in choice_formset %}
                                                                <div>
                                                                    {{ form_c.as_p }}
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                        </script>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        </script>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </script>
                </div>
                
                <form action="" method="post">
                    <button type="submit" class="btn btn-primary rounded-pill btn-mostaza">{% trans "StudiesButtom" %}</button>
                    <a href="{% url 'my-studies' %}" class="btn btn-primary rounded-pill btn-terracota mt-3">{% trans "ReturnToStudyList" %}</a>
                </form>
            </div>
        </div>
    </div>
    

    <script>
        $(document).ready(function () {
            // Función para comprobar que los campos del cuestionario tienen datos
            function checkQuestionnaireFields() {
                var name = $("#id_name").val().trim();
                var lang = $("#id_language").val().trim();
                if (name !== "" && lang !== "") {
                    $("#create-section-btn").prop("disabled", false);
                } else {
                    $("#create-section-btn").prop("disabled", true);
                }
            }
            // Escuchar cambios en los inputs y textarea del cuestionario
            $("#questionnaire-form input, #questionnaire-form textarea").on("input", checkQuestionnaireFields);

            // Variable para llevar el índice de secciones
            var sectionIndex = 0;

            // Al pulsar "Crear Sección" se añade una nueva sección
            $("#create-section-btn").click(function (e) {
                e.preventDefault();
                var sectionTemplate = $("#section-template").html();
                var newSectionHtml = sectionTemplate.replace(/__index__/g, sectionIndex);
                $("#sections-container").append(newSectionHtml);
                sectionIndex++;
            });

            // Delegar evento: cuando se escriba en el título de la sección, habilitar el botón "Añadir Pregunta" si hay texto.
            $(document).on("input", ".section-form input[id^='id_sections-']", function () {
                var $sectionForm = $(this).closest(".section-form");
                var titleVal = $(this).val().trim();
                if (titleVal !== "") {
                    $sectionForm.find(".add-question-btn").prop("disabled", false);
                } else {
                    $sectionForm.find(".add-question-btn").prop("disabled", true);
                }
            });

            $(document).on("input", ".section-form input[id$='-DELETE']", function () {
                var $sectionForm = $(this).closest(".section-form");
                var titleVal = $(this).val().trim();
                if (titleVal !== "") {
                    $sectionForm.find(".add-question-btn").prop("disabled", false);
                } else {
                    $sectionForm.find(".add-question-btn").prop("disabled", true);
                }
            });

            // Variable para llevar el índice de secciones
            var questionIndex = 0;

            // Delegar evento: al pulsar "Añadir Pregunta" en una sección, añadir un formulario de pregunta
            $(document).on("click", ".add-question-btn", function (e) {
                e.preventDefault();
                var $sectionForm = $(this).closest(".section-form");
                // Obtener el índice de la sección desde el atributo data-index
                var sindex = $sectionForm.attr("data-index");
                // Contar las preguntas existentes en esa sección para determinar el índice de la nueva pregunta
                var qCount = $sectionForm.find(".questions-container .question-form").length;
                // Obtener la plantilla del formulario de pregunta
                var questionTemplate = $("#question-template").html();
                var newQuestionHtml = questionTemplate.replace(/__sindex__/g, sindex)
                    .replace(/__qindex__/g, qCount).replace(/__index__/g, questionIndex);
                // Añadir el nuevo formulario al contenedor de preguntas de esa sección
                $sectionForm.find(".questions-container").append(newQuestionHtml);
            });

            // Delegar evento: cuando se escriba en el título de la sección, habilitar el botón "Añadir Pregunta" si hay texto.
            $(document).on("input", ".question-form input[id^='id_questions-']", function () {
                var $sectionForm = $(this).closest(".question-form");
                var titleVal = $(this).val().trim();
                if (titleVal !== "") {
                    $sectionForm.find(".add-choice-btn").prop("disabled", false);
                } else {
                    $sectionForm.find(".add-choice-btn").prop("disabled", true);
                }
            });

            // Delegar evento: al pulsar "Añadir Pregunta" en una sección, añadir un formulario de pregunta
            $(document).on("click", ".add-choice-btn", function (e) {
                e.preventDefault();
                var $questionForm = $(this).closest(".question-form");
                // Obtener el índice de la sección desde el atributo data-index
                var sindex = $questionForm.attr("data-index");
                // Contar las preguntas existentes en esa sección para determinar el índice de la nueva pregunta
                var qCount = $questionForm.find(".choices-container .choice-form").length;
                // Obtener la plantilla del formulario de pregunta
                var choiceTemplate = $("#choice-template").html();
                var newChoiceHtml = choiceTemplate.replace(/__sindex__/g, sindex)
                    .replace(/__qindex__/g, qCount);
                // Añadir el nuevo formulario al contenedor de preguntas de esa sección
                $questionForm.find(".choices-container").append(newChoiceHtml);
            });
        });
    </script>

    {% endblock body %}