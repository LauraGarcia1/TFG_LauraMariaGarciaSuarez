{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block body %}

<div class="position-relative custom-container zindex-0">
    <div class="position-absolute top-50 start-50 translate-middle negative-padding-bottom zindex-0">
        <img src="{% static 'images/dicesNoback.png' %}" alt="Image" draggable="false" class="overflow-hidden"
            style="transform: rotate(31deg);">
    </div>

    <div class="shadow-lg p-4 bg-body rounded rounded-5 position-absolute top-50 start-50 translate-middle border border-dark border-2 w-75 m-auto"
        style="max-height: 80vh; max-width: 720px;">
        <h2 class="pb-4 text-center fw-bold">Sign up</h2>
        <form action="" method="post" class="d-flex flex-column justify-content-center align-items-center w-100 h-100" style="max-height: 50%;">
        {% csrf_token %}
        <div class="scroll-hover w-100">
            <div class="mb-4 w-100">
                <label for="username" class="form-label fw-bold required">{% trans "Username" %}:</label>
                <input type="text" id="username" name="username" class="form-control rounded-pill w-100"
                    value="{{ username }}" required>
            </div>
            <div class="mb-4">
                <label for="password" class="form-label fw-bold required">{% trans "Password" %}:</label>
                <input type="password" id="password" name="password" class="form-control rounded-pill"
                    value="{{ password }}" required>
                <div id="password-error-message" class="text-danger"></div>
            </div>
            <div class="mb-4">
                <label for="name" class="form-label fw-bold required">{% trans "Name" %}:</label>
                <input type="text" id="name" name="name" class="form-control rounded-pill" required>
            </div>
            <div class="mb-4">
                <label for="email" class="form-label fw-bold required">{% trans "Email" %}:</label>
                <input type="email" id="email" name="email" class="form-control rounded-pill" required>
                <div id="email-error-message" class="text-danger"></div>
            </div>
            <div class="mb-4">
                <label for="location" class="form-label fw-bold required">{% trans "Location" %}:</label>
                <input type="text" id="location" name="location" class="form-control rounded-pill" required>
                <div id="results"></div>
            </div>
            <div class="mb-4">
                <label for="age" class="form-label fw-bold required">{% trans "Age" %}:</label>
                <input type="number" id="age" name="age" class="form-control rounded-pill" min="0" max="120"
                    required>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold required" id="frequencyLabel">{% trans "Frequency" %}Frequently played table
                    games:</label>
                <div>
                    <span class="tab"></span><input type="radio" id="morethan" name="option" value="3">
                    <label for="morethan">{% trans "More than" %}</label>
                </div>

                <div>
                    <span class="tab"></span><input type="radio" id="week" name="option" value="2">
                    <label for="week">{% trans "Week" %}</label>
                </div>

                <div>
                    <span class="tab"></span><input type="radio" id="lifetime" name="option" value="1">
                    <label for="lifetime">{% trans "Lifetime" %}</label>
                </div>

                <div>
                    <span class="tab"></span><input type="radio" id="never" name="option" value="0">
                    <label for="never">{% trans "Never" %}</label>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold required" id="expertiseLabel">{% trans "Expertise" %}:</label>
                <div>
                    <span class="tab"></span><input type="radio" id="beginner" name="optionSecond" value="0">
                    <label for="beginner">{% trans "Beginner" %}</label>
                </div>

                <div>
                    <span class="tab"></span><input type="radio" id="intermediate" name="optionSecond" value="1">
                    <label for="intermediate">{% trans "Intermediate" %}</label>
                </div>

                <div>
                    <span class="tab"></span><input type="radio" id="advanced" name="optionSecond" value="2">
                    <label for="advanced">{% trans "Advanced" %}</label>
                </div>

            </div>

        </div>
        <br>
        <br>
        <br>
        <footer class="footer fixed-bottom text-center">
            <button type="submit" class="btn btn-primary rounded-pill btn-terracota w-50 m-auto" id="submitButton"
                    disabled>{% trans "Sign up" %}</button>
            <br><span class="text-muted" id="infoMessage">{% trans "RequiredFields" %}</span>
        </footer>
        
    </div>
</div>


<script>
    /* SCRIPT THAT MANAGES THE LOCATION FIELD */
    const input = document.getElementById('location');
    const resultsContainer = document.getElementById('results');
    let locationSelected = false;  // Flag to check if a location was selected

    input.addEventListener('input', function () {
        const query = this.value;
        locationSelected = false;
        input.classList.remove('is-valid', 'is-invalid');  // To remove classes when typing in the fields
        resultsContainer.innerHTML = ''; // Clean previews results for the location field

        if (query.length < 3) {
            return; // If the location has 3 or less characters, don't search
        }

        // MAke a query to the API of Nominatim
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                resultsContainer.innerHTML = ''; // Clean previews results
                if (data.length > 0) {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item.display_name;
                        div.className = 'result-item';
                        div.onclick = () => selectLocation(item);  // Select the location when is clicked
                        resultsContainer.appendChild(div);
                    });
                } else {
                    // If there are none results, marked as invalid the field
                    input.classList.add('is-invalid');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    function selectLocation(item) {
        // Establish the input value with the selected location name
        input.value = item.display_name;

        // Clean results
        resultsContainer.innerHTML = '';

        // Marked the field as valid
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');

        // Activate the selected location flag
        locationSelected = true;

        // Check again the form
        checkForm();
    }

    // Function that returns the locationSelected which specifies if it's valid
    function isLocationValid() {
        return locationSelected;
    }

    /* SCRIPT THAT MANAGES THE SUBMIT BUTTON */
    // Function to check all the fields
    function checkForm() {
        // Select all the inputs required
        const inputs = document.querySelectorAll('input[required]');
        let allFilled = true;

        // Validate all the fields, except password field, email field and location field.
        inputs.forEach(input => {
            if (input.id === 'email' || input.id === 'password' || input.id === 'location') {
                return;
            }

            // Verify if the field is filled
            if (input.value.trim() !== '') {
                // Add valid class
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
            } else {
                // Add invalid class
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                allFilled = false;
            }
        });

        // Section to validate radio fields
        const radios = document.getElementsByName('option');
        const radiosSecond = document.getElementsByName('optionSecond');
        const label = document.getElementById('frequencyLabel');
        const labelSecond = document.getElementById('expertiseLabel');
        let isRadioChecked = false;
        let isRadioSecChecked = false;

        for (const radio of radios) {
            if (radio.checked) {
                isRadioChecked = true;
                label.classList.add('valid');
                break;
            }
        }

        for (const radio of radiosSecond) {
            if (radio.checked) {
                isRadioSecChecked = true;
                labelSecond.classList.add('valid');
                break;
            }
        }

        if (!isRadioChecked) {
            allFilled = false;
        }

        if (!isRadioSecChecked) {
            allFilled = false;
        }

        // Validate password, email and location
        if (!validatePassword()) {
            allFilled = false;
        }

        if (!validateEmail()) {
            allFilled = false;
        }

        if (!isLocationValid()) {
            allFilled = false;
        }

        // Able or disable the submit button if everything id filled and validated
        document.getElementById('submitButton').disabled = !allFilled;
        document.getElementById('infoMessage').style.display = submitButton.disabled ? 'block' : 'none';
    }

    // Establish listeners for every field
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('input[required]');
        inputs.forEach(input => input.addEventListener('input', checkForm));

        const radios = document.getElementsByName('option');
        radios.forEach(radio => radio.addEventListener('change', checkForm));

        const radiosSecond = document.getElementsByName('optionSecond');
        radiosSecond.forEach(radio => radio.addEventListener('change', checkForm));
    });

    // Validate password
    function validatePassword() {
        const passwordInput = document.getElementById('password');
        const password = passwordInput.value;
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        let errorMessage = '';

        if (password.length < minLength) {
            errorMessage += 'Password must be at least 8 characters long.<br>';
        }
        if (!hasUpperCase) {
            errorMessage += 'Password must contain at least one uppercase letter.<br>';
        }
        if (!hasLowerCase) {
            errorMessage += 'Password must contain at least one lowercase letter.<br>';
        }
        if (!hasNumbers) {
            errorMessage += 'Password must contain at least one number.<br>';
        }
        if (!hasSpecialChar) {
            errorMessage += 'Password must contain at least one special character.<br>';
        }

        const messageDiv = document.getElementById('password-error-message');
        messageDiv.innerHTML = errorMessage;

        if (errorMessage === '') {
            passwordInput.classList.add('is-valid');
            passwordInput.classList.remove('is-invalid');
            return true;
        } else {
            passwordInput.classList.add('is-invalid');
            passwordInput.classList.remove('is-valid');
            return false;
        }
    }

    // Validate email
    function validateEmail() {
        const emailInput = document.getElementById('email');
        const email = emailInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const allowedDomains = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'estudiante.uam.es', 'msn.com'];

        let errorMessage = '';

        // Is the format right?
        if (!emailRegex.test(email)) {
            errorMessage += 'Please enter a valid email address.<br>';
        }

        // Is the domain right?
        const domain = email.split('@')[1];
        if (domain && !allowedDomains.includes(domain)) {
            errorMessage += `Only email addresses from ${allowedDomains.join(', ')} are allowed.<br>`;
        }

        const messageDiv = document.getElementById('email-error-message');
        messageDiv.innerHTML = errorMessage;

        if (errorMessage === '') {
            emailInput.classList.add('is-valid');
            emailInput.classList.remove('is-invalid');
            return true;
        } else {
            emailInput.classList.add('is-invalid');
            emailInput.classList.remove('is-valid');
            return false;
        }
    }


</script>


{% endblock body %}