{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block overflow %}

<body style="overflow-x: hidden;">
    {% endblock overflow %}

    {% block body %}
    <div class="position-relative custom-container">
        <div class="position-absolute top-0 start-0">
            <img src="{% static 'images/dicesLeft.png' %}" alt="Image" draggable="false"
                style="transform: rotate(64deg);">
        </div>

        <div class="position-absolute bottom-0 end-0">
            <img src="{% static 'images/dicesRight.png' %}" alt="Image" draggable="false"
                style="transform: rotate(31deg);">
        </div>

        <form enctype="multipart/form-data" class="container" method="post" id="questionnarie_form">
            {% csrf_token %}
            <div
                class="justify-content-start shadow-lg p-5 bg-body rounded rounded-5 position-absolute top-0 start-50 translate-middle-x border border-dark border-2 custom-width">
                <div class="row h-100 p-5 rounded rounded-5 border border-dark border-1 w-100 background-creme">
                    <h1>{% trans "CreateStudyTitle" %}</h1>
                    {% for field in form %}
                    <div class="form-group card-body">
                        <label>{{field.label}}</label>
                        {% if field.field.required %}
                        <span style="color: red;" class="required">*</span>
                        {% endif %}

                        {{field}}
                        {% if field.help_text %}
                        <small style="color: grey">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                        <p style="color: red">{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endfor %}

                    <!-- Formset de Section -->
                    <div>
                        <h3>Sections</h3>

                        {% with named_formsets.sections as formset %}
                        {{ formset.management_form }}
                        <script type="text/html" id="sections-template">  // id="inlineformsetname-template"
                        // id='inlineformsetname-__prefix__' 
                        <tr id="sections-__prefix__" class="hide_all">
                            {% for fields in formset.empty_form.hidden_fields %}
                                {{ fields }}
                            {% endfor %}
                        
                            {% for fields in formset.empty_form.visible_fields %}
                                <td>{{fields}}</td>
                            {% endfor %}
                        </tr>
                    </script>
                        <div class="table-responsive card mt-4">
                            <div class="card-header card-header-secondary">
                                <h4 class="card-title">Add Sections</h4>
                            </div>
                            <table class="table card-header">
                                <thead class="text-secondary">
                                    <th>Title <span style="color: red;" class="required">*</span></th>
                                </thead>
                                <tbody id="item-sections"> <!-- id="item-inlineformsetname" -->
                                    <!-- formset non forms errors -->
                                    {% for error in formset.non_form_errors %}
                                    <span style="color: red">{{ error }}</span>
                                    {% endfor %}
                                    {% for formss in formset %}
                                    {{ formss.management_form }}
                                    <tr id="sections-{{ forloop.counter0 }}" class="hide_all">
                                        <!-- id="inlineformsetname-counter" -->
                                        {{ formss.id }}
                                        {% for field in formss.visible_fields %}
                                        <td>
                                            {{field}}
                                            {% for error in field.errors %}
                                            <span style="color: red">{{ error }}</span>
                                            {% endfor %}

                                            {% comment %} {{ field.DELETE }} {% endcomment %}
                                        </td>
                                        {% endfor %}
                                        {% comment %} for delete {% endcomment %}
                                        {% if formss.instance.pk %}
                                        <td>
                                            <button type="button" class="btn btn-danger" data-toggle="modal"
                                                data-target="#exampleModal{{formss.instance.pk}}">
                                                Delete
                                            </button>
                                            <!-- Modal -->
                                            <div class="modal fade" id="exampleModal{{formss.instance.pk}}"
                                                tabindex="-1" role="dialog"
                                                aria-labelledby="exampleModalLabel{{formss.instance.pk}}"
                                                aria-hidden="true">
                                                <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title"
                                                                id="exampleModalLabel{{formss.instance.pk}}">Are Your
                                                                Sure You Want To Delete This?</h5>
                                                            <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <a href="{% url 'products:delete_section' formss.instance.pk %}"
                                                                type="button" class="btn btn-primary">Yes, Delete</a>
                                                            <button type="button" class="btn btn-secondary"
                                                                data-dismiss="modal">Close</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <a href="#" id="add-section-button" class="btn btn-secondary add-sections">Add More</a>
                            <!-- id="add-inlineformsetname-button" -->
                        </div>

                        {% endwith %}

                    </div>

                    <!-- Botón para añadir más secciones -->
                    <button type="submit" class="btn btn-primary rounded-pill btn-mostaza">{% trans "StudiesButtom"
                        %}</button>
                    <a href="{% url 'my-studies' %}" class="btn btn-primary rounded-pill btn-terracota mt-3">{% trans
                        "ReturnToStudyList" %}</a>
                </div>
            </div>
        </form>
    </div>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            // when user clicks add more btn of sections
            $('.add-sections').click(function (ev) {
                console.log("Entreeee")
                ev.preventDefault();
                var count = $('#item-sections').children().length;
                var tmplMarkup = $('#sections-template').html();
                var compiledTmpl = tmplMarkup.replace(/__prefix__/g, count);
                $('#item-sections').append(compiledTmpl);

                // update form count
                $('#id_sections-TOTAL_FORMS').attr('value', count + 1);
            });
        });
    </script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Delegar el evento de clic al contenedor de secciones
        $("#section-formset").on("click", ".add-question", function (ev) {
            ev.preventDefault();

            // Obtener la sección correspondiente al botón "Añadir Pregunta"
            var section = $(this).closest(".section-form");

            // Contar cuántos formularios de preguntas hay actualmente en esta sección
            var questionCount = section.find(".question-formset .question-form").length;

            // Obtener la plantilla del formulario vacío de pregunta
            var tmplMarkup = section.find(".question-form:first").clone(true).html();
            var compiledTmpl = tmplMarkup.replace(/__prefix__/g, questionCount);

            // Agregar el formulario de pregunta al contenedor de preguntas
            section.find(".question-formset").append(compiledTmpl);

            // Limpiar los valores de los inputs en el nuevo formulario de pregunta
            section.find(".question-formset .question-form:last input").val("");

            // Actualizar el número total de formularios de preguntas para la sección
            var totalQuestionsInput = section.find(".question-formset .total-questions");
            var currentTotal = parseInt(totalQuestionsInput.val() || 0, 10);
            totalQuestionsInput.val(currentTotal + 1);
        });

        // Agregar una nueva sección
        $("#add-section").click(function (ev) {
            ev.preventDefault();

            // Contar cuántos formularios de sección hay actualmente
            var count = $("#section-formset .section-form").length;

            // Obtener el formulario vacío de la plantilla (sin clonar, solo creando una nueva instancia)
            var tmplMarkup = $("#section-template").html();
            var compiledTmpl = tmplMarkup.replace(/{{ section_formset.prefix }}/g, count);

            // Agregar el formulario de sección al formset
            $("#section-formset").append(compiledTmpl);

            // Limpiar valores de los campos en el nuevo formulario de sección
            $("#section-formset .section-form:last input").val("");

            // Actualizar total de formularios en el formset
            $("#id_sections-TOTAL_FORMS").val(count + 1);
        });
    });

    // Delegar evento de clic para eliminar sección
    $("#section-formset").on("click", ".delete-section", function (ev) {
        ev.preventDefault();

        // Encontrar el formulario de la sección
        var sectionForm = $(this).closest(".section-form");

        // Marcar el campo DELETE como verdadero
        sectionForm.find("input[name$='-DELETE']").prop("checked", true);

        // Ocultar la sección (esto no la elimina del DOM, solo la oculta)
        sectionForm.hide();

        // Si prefieres eliminarla completamente del DOM, puedes hacer:
        // sectionForm.remove();
    });

    // Delegar evento de clic para eliminar pregunta
    $("#section-formset").on("click", ".delete-question", function (ev) {
        ev.preventDefault();

        // Encontrar el formulario de la pregunta
        var questionForm = $(this).closest(".question-form");

        // Marcar el campo DELETE como verdadero
        questionForm.find("input[name$='-DELETE']").prop("checked", true);

        // Ocultar la pregunta (esto no la elimina del DOM, solo la oculta)
        questionForm.hide();

        // Si prefieres eliminarla completamente del DOM, puedes hacer:
        // questionForm.remove();
    });


</script>

    {% endblock body %}