{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block overflow %}

<body style="overflow-x: hidden;">
    {% endblock overflow %}

    {% block body %}
  <style>
    /* Estilos básicos para la demostración */
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 20px; }
    .section-form, .question-form { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .section-form { background-color: #f9f9f9; }
    .question-form { background-color: #e9e9e9; }
    .disabled-btn { opacity: 0.5; pointer-events: none; }
  </style>

  <h2>Crear Cuestionario</h2>
  <!-- Formulario del cuestionario -->
  <form id="questionnaire-form">
    <label for="q-name">Nombre:</label>
    <input type="text" id="q-name" name="name"><br><br>
    
    <label for="q-description">Descripción:</label>
    <textarea id="q-description" name="description"></textarea><br><br>
    
    <label for="q-language">Idioma:</label>
    <input type="text" id="q-language" name="language"><br><br>
  </form>
  
  <!-- Botón para crear secciones (inicialmente deshabilitado) -->
  <button id="create-section-btn" disabled>Crear Sección</button>
  
  <!-- Contenedor para las secciones -->
  <div id="sections-container">
    <!-- Aquí se añadirán las secciones dinámicamente -->
  </div>
  
  <!-- Plantilla oculta para la sección (usamos __index__ como marcador) -->
  <script type="text/template" id="section-template">
    <div class="section-form" data-index="__index__">
      <h3>Sección</h3>
      <label for="section-title-__index__">Título de la Sección:</label>
      <input type="text" id="section-title-__index__" name="sections[__index__][title]"><br><br>
      
      <!-- Botón para añadir preguntas (inicialmente deshabilitado) -->
      <button class="add-question-btn" disabled>Añadir Pregunta</button>
      
      <!-- Contenedor para las preguntas de esta sección -->
      <div class="questions-container">
        <!-- Se agregarán los formularios de preguntas aquí -->
      </div>
    </div>
  </script>
  
  <!-- Plantilla oculta para el formulario de pregunta (marcadores: __sindex__ para la sección y __qindex__ para la pregunta) -->
  <script type="text/template" id="question-template">
    <div class="question-form">
      <label for="question-text-__sindex____qindex__">Pregunta:</label>
      <input type="text" id="question-text-__sindex____qindex__" name="sections[__sindex__][questions][__qindex__][text]"><br>
    </div>
  </script>
  
  <script>
    $(document).ready(function() {
      // Función para comprobar que los campos del cuestionario tienen datos
      function checkQuestionnaireFields() {
        var name = $("#q-name").val().trim();
        var desc = $("#q-description").val().trim();
        var lang = $("#q-language").val().trim();
        if (name !== "" && desc !== "" && lang !== "") {
          $("#create-section-btn").prop("disabled", false);
        } else {
          $("#create-section-btn").prop("disabled", true);
        }
      }
      // Escuchar cambios en los inputs y textarea del cuestionario
      $("#questionnaire-form input, #questionnaire-form textarea").on("input", checkQuestionnaireFields);
      
      // Variable para llevar el índice de secciones
      var sectionIndex = 0;
      
      // Al pulsar "Crear Sección" se añade una nueva sección
      $("#create-section-btn").click(function(e) {
        e.preventDefault();
        var sectionTemplate = $("#section-template").html();
        var newSectionHtml = sectionTemplate.replace(/__index__/g, sectionIndex);
        $("#sections-container").append(newSectionHtml);
        sectionIndex++;
      });
      
      // Delegar evento: cuando se escriba en el título de la sección, habilitar el botón "Añadir Pregunta" si hay texto.
      $(document).on("input", ".section-form input[name^='sections'][name$='[title]']", function() {
        var $sectionForm = $(this).closest(".section-form");
        var titleVal = $(this).val().trim();
        if (titleVal !== "") {
          $sectionForm.find(".add-question-btn").prop("disabled", false);
        } else {
          $sectionForm.find(".add-question-btn").prop("disabled", true);
        }
      });
      
      // Delegar evento: al pulsar "Añadir Pregunta" en una sección, añadir un formulario de pregunta
      $(document).on("click", ".add-question-btn", function(e) {
        e.preventDefault();
        var $sectionForm = $(this).closest(".section-form");
        // Obtener el índice de la sección desde el atributo data-index
        var sindex = $sectionForm.attr("data-index");
        // Contar las preguntas existentes en esa sección para determinar el índice de la nueva pregunta
        var qCount = $sectionForm.find(".questions-container .question-form").length;
        // Obtener la plantilla del formulario de pregunta
        var questionTemplate = $("#question-template").html();
        var newQuestionHtml = questionTemplate.replace(/__sindex__/g, sindex)
                                              .replace(/__qindex__/g, qCount);
        // Añadir el nuevo formulario al contenedor de preguntas de esa sección
        $sectionForm.find(".questions-container").append(newQuestionHtml);
      });
    });
  </script>

    {% endblock body %}